<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="author" content="Hongbo Zhang">
<title>BuckleScript User Manual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1><a href="https://github.com/bloomberg/bucklescript">BuckleScript</a> User Manual</h1>
<div class="details">
<span id="author" class="author">Hongbo Zhang</span><br>
<span id="email" class="email"><a href="mailto:bobzhang1988@gmail.com">bobzhang1988@gmail.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_why_bucklescript">Why BuckleScript</a>
<ul class="sectlevel2">
<li><a href="#_the_benefit_of_javascript_platform">The benefit of JavaScript platform</a></li>
<li><a href="#_problems_of_javascript_langauge_and_how_bucklescript_solves_it">Problems of JavaScript langauge and how BuckleScript solves it</a></li>
</ul>
</li>
<li><a href="#_get_started">Get Started</a>
<ul class="sectlevel2">
<li><a href="#_installation">Installation</a></li>
<li><a href="#_ocaml_ecosystem_opam">OCaml ecosystem: OPAM</a></li>
<li><a href="#_first_example_in_bucklescript">First example in BuckleScript</a></li>
</ul>
</li>
<li><a href="#_bucklescript_basics">BuckleScript Basics</a></li>
<li><a href="#why-bucklescript">Why <a href="https://github.com/bloomberg/bucklescript">BuckleScript</a>?</a></li>
<li><a href="#resources-for-learning-ocaml">Resources for Learning OCaml</a>
<ul class="sectlevel2">
<li><a href="#to-deploy-your-ocaml-library-as-a-npm-package">To deploy your OCaml library as a npm package</a></li>
<li><a href="#to-use-ocaml-library-as-a-npm-package">To use OCaml library as a npm package</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#_bucklescript_basics_2">BuckleScript Basics</a>
<ul class="sectlevel2">
<li><a href="#hello-world">Hello world</a></li>
<li><a href="#design-principles">Design Principles</a></li>
</ul>
</li>
<li><a href="#js-calling-ocaml">JS Calling OCaml</a>
<ul class="sectlevel2">
<li><a href="#ffi-to-first-order-js-functions">FFI to first-order JS functions</a></li>
<li><a href="#ffi-to-high-order-js-functions">FFI to high-order JS functions</a></li>
<li><a href="#ffi-to-js-plain-objects">FFI to JS plain objects</a></li>
<li><a href="#ffi-to-js-classes">FFI to JS classes</a></li>
<li><a href="#embedding-raw-javascript-code">Embedding raw Javascript code</a></li>
<li><a href="#debugger-support">Debugger support</a></li>
<li><a href="#regex-support">Regex support</a></li>
<li><a href="#examples">Examples:</a></li>
</ul>
</li>
<li><a href="#ocaml-type">OCaml type</a>
<ul class="sectlevel2">
<li><a href="#int">int</a></li>
<li><a href="#nativeint">nativeint</a></li>
<li><a href="#int32">int32</a></li>
<li><a href="#int64">int64</a></li>
<li><a href="#float">float</a></li>
<li><a href="#bool">bool</a></li>
<li><a href="#char">char</a></li>
<li><a href="#string">string</a></li>
<li><a href="#bytes">bytes</a></li>
<li><a href="#array">array</a></li>
<li><a href="#record-internal">record <em>internal</em></a></li>
<li><a href="#tuple">tuple</a></li>
<li><a href="#a-option-internal"><code>'a option</code> <em>internal</em></a></li>
<li><a href="#a-list-internal"><code>'a list</code> <em>internal</em></a></li>
<li><a href="#variant-internal">Variant <em>internal</em></a></li>
<li><a href="#polymorphic-variant-internal">Polymorphic variant <em>internal</em></a></li>
<li><a href="#exception-internal">exception <em>internal</em></a></li>
<li><a href="#extension-internal">extension <em>internal</em></a></li>
<li><a href="#object-internal">object <em>internal</em></a></li>
</ul>
</li>
<li><a href="#javascript-type-exposed-to-ocaml">JavaScript type exposed to OCaml</a>
<ul class="sectlevel2">
<li><a href="#js.boolean"><code>Js.boolean</code></a></li>
<li><a href="#a-js.opt"><code>'a Js.opt</code></a></li>
<li><a href="#a-js.def"><code>'a Js.def</code></a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">This document is under active development and discussion!</div>
<div class="paragraph">
<p>If you find errors or omissions in this document, please don&#8217;t
hesitate to <a href="https://github.com/bloomberg/bucklescript/issues">submit an issue</a> with a fix.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>BuckleScript is a backend for the <a href="https://ocaml.org/">OCaml</a> compiler which emits
JavaScript. It works with both vanilla OCaml and <a href="https://github.com/facebook/Reason">Reason</a>, the
whole compiler is compiled into JS (and ASM) so that you can play it
in the <a href="http://bloomberg.github.io/bucklescript/js-demo/">browser</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_bucklescript">Why BuckleScript</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_benefit_of_javascript_platform">The benefit of JavaScript platform</h3>
<div class="paragraph">
<p>JavaScript is not just <strong>the</strong> browser language, it&#8217;s also the <strong>only</strong>
existing cross platform language. It is truly everywhere: users don&#8217;t
need to install binaries or use package managers to access software,
just a link will work.</p>
</div>
<div class="paragraph">
<p>Another important factor is that the JavaScript VM is quite fast and
keeps getting faster.  The JavaScript platform is therefore
increasingly capable of supporting large applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_problems_of_javascript_langauge_and_how_bucklescript_solves_it">Problems of JavaScript langauge and how BuckleScript solves it</h3>
<div class="paragraph">
<p>BuckleScript is mainly designed to solve the problems of <strong>large scale JavaScript programming</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lack of type-safety:
<a href="https://ocaml.org/">OCaml</a> offers an industrial-strength
state-of-the-art type system and provides type inference (i.e. No
verbose type annotation required), which proves
<a href="http://programmers.stackexchange.com/questions/215482/what-are-the-safety-benefits-of-a-type-system">invaluable</a>
in managing large projects.</p>
</li>
<li>
<p>Dead code: A large amount of web-development relies on inclusion of
code dependencies by copying or referencing CDNs (the very thing
that makes JavaScript highly accessible), but this also introduces
a lot of <a href="https://en.wikipedia.org/wiki/Dead_code">dead code</a>. This
impacts performance adversely when the JavaScript VM has to
interpret code that will never be invoked. BuckleScript provides
powerful dead-code elimination at all levels:</p>
<div class="ulist">
<ul>
<li>
<p>Function and module level elimination is facilitated by the
sophistication of the type-system of OCaml and
purity analysis.</p>
</li>
<li>
<p>At the global level BuckleScript generates code ready for
dead-code elimination done by bundling tools such as the
<a href="https://developers.google.com/closure/compiler/">Google closure-compiler</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Lack of offline optimizations: JavaScript is a dynamic language, it
takes a performance-hit for the VM to optimize code at runtime.
While some JS engines circumvent the problem to some extent by
<a href="http://v8project.blogspot.com/2015/07/code-caching.html">caching</a>,
this is not available to all environments, and lack of a strong
type system also limits the level of optimizations possible. Again,
BuckleScript, using features of the OCaml type-system and compiler
implementation is able to provide many optimizations during offline
compilation, allowing the runtime code to be extremely fast.</p>
</li>
<li>
<p>Run your programs on all platforms, but run your system <strong>faster</strong>
under specific platforms. Javascript is everywhere but it does not
mean we have to run all apps in JS, under several platforms, for
example, server side or iOS/Android native apps, when programs are
written in OCaml, it can also be compiled to native code for <strong>best
performance</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While a strong type-system helps in countering these problems, at the
same time we hope to avoid some of the problems faced in using other
offline <a href="https://github.com/jashkenas/coffeescript/wiki/list-of-languages-that-compile-to-js">transpilation systems</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Slow compilation: OCaml bytecode compilation is known to be fast
  (one or two orders of magnitude faster than other similar langauges:
<a href="http://www.scala-lang.org/">Scala</a> or
  <a href="https://www.haskell.org/">Haskell</a>),
  BuckleScript shares the same property and compiles even faster
  since it saves the link time. See the speeds at work in the
  <a href="http://bloomberg.github.io/bucklescript/js-demo/">playground</a>, the native backend is one
  order faster than the JS backend.</p>
</li>
<li>
<p>Un-readable JS Code and hard to integrate with existing JS
libraries: When compiling to JavaScript, many systems
generate code, that while syntactically and semantically correct is
not human-readable and very difficult to debug and profile.
Our BuckleScript implementation and the multi-pass compilation  strategy of OCaml,
allows us to avoid <a href="https://en.wikipedia.org/wiki/Name_mangling">name-mangling</a>,
and produce JavaScript code that is human-readable and easier to debug and
maintain. More importantly, this makes intergration with existing JS
libraries much easier.</p>
</li>
<li>
<p>Loss of code-structure: Many systems generate JavaScript code that is essentially a
<a href="https://en.wikipedia.org/wiki/Big_ball_of_mud">big ball of mud</a>. We try
to keep the original structure of the code by mapping one OCaml module
to one JS module.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started">Get Started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation">Installation</h3>
<div class="sect3">
<h4 id="_install_from_npm_releases">Install from NPM releases</h4>
<div class="paragraph">
<p>The standard npm package management tool can be used to install
BuckleScript. If you don&#8217;t already have npm installed, follow the
directions listed
<a href="https://docs.npmjs.com/getting-started/installing-node">here</a>. Once npm
is installed, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">npm install --save bs-platform</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_from_source_with_code_npm_code_package_manager">Install from source with <code>npm</code> package manager</h4>
<div class="olist arabic">
<div class="title">Prerequisites:</div>
<ol class="arabic">
<li>
<p>Standard C toolchain</p>
</li>
<li>
<p><code>npm</code> (should be installed with Node)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Instructions:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">git clone https://github.com/bloomberg/bucklescript
<span class="tok-nb">cd </span>bucklescript
npm install</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_with_minimal_dependencies">Install with minimal dependencies</h4>
<div class="olist arabic">
<div class="title">Prerequisites:</div>
<ol class="arabic">
<li>
<p>Standard C toolchain</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>BuckleScript has very few dependencies and building from source can
easily be done.</p>
</div>
<div class="listingblock">
<div class="title">Build OCaml compiler</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">git clone --recursive https://github.com/bloomberg/bucklescript
<span class="tok-nb">cd </span>ocaml
./configure -prefix <span class="tok-sb">`</span><span class="tok-nb">pwd</span><span class="tok-sb">`</span> <span class="tok-c"># put your preferred directory</span>
make world.opt
make install</code></pre>
</div>
</div>
<div class="paragraph">
<p>The patched compiler is installed locally into your <code>$(pwd)/bin</code>
directory. To start using it temporarily, check if <code>ocamlc.opt</code> and
<code>ocamlopt.opt</code> exist in <code>$(pwd)/bin</code>, and temporarily add the location
to your <code>$(PATH)</code> (e.g.  <code>PATH=$(pwd)/bin:$PATH</code>).</p>
</div>
<div class="paragraph">
<div class="title">Building BuckleScript</div>
<p>The following directions assume you already have the correct version of
<code>ocamlopt.opt</code> in your <code>$PATH</code>, having followed the process described in
the previous section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nb">export </span><span class="tok-nv">BS_RELEASE_BUILD</span><span class="tok-o">=</span>1
make world</code></pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>At the end, you should have a binary called <code>bsc</code> under <code>jscomp/bin</code>
directory, which you can add to your <code>$PATH</code>.
You could also set an environment variable
pointing to the stdlib, e.g. <code>BSC_LIB=/path/to/jscomp/stdlib</code> for ease
of use.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ocaml_ecosystem_opam">OCaml ecosystem: OPAM</h3>
<div class="paragraph">
<p>When working with OCaml we also recommend using <a href="https://opam.ocaml.org">opam</a>
package manager to install OCaml tools, available
<a href="https://opam.ocaml.org/doc/Install.html">here</a>. You will benefit from the
existing OCaml ecosystem.</p>
</div>
<div class="paragraph">
<p>Once you have <code>opam</code> installed, ask <code>opam</code> to switch to using our
version of the compiler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">opam update
opam switch 4.02.3
<span class="tok-nb">eval</span> <span class="tok-sb">`</span>opam config env<span class="tok-sb">`</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_first_example_in_bucklescript">First example in BuckleScript</h3>
<div class="paragraph">
<p>Also see <a href="./Create-a-simple-example-with-NPM.adoc">Create a simple
example with npm</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bucklescript_basics">BuckleScript Basics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The compiler does not build</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In production mode, the compiler is a single file in
<code>jscomp/bin/compiler.ml</code>. If it is not compiling, make sure you have the
right OCaml compiler version. Currently the OCaml compiler is a
submodule of bucklescript. Make sure the exact commit hash matches (we
only update the compiler occasionally).
* <a href="./Compiler-options.adoc">Compiler options</a>
* <a href="./How-to-adapt-your-build-system.adoc">How to adapt your build
system</a>
* <a href="./Semantic-differences-from-other-backends.adoc">Semantic
differences from other backends</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why-bucklescript">Why <a href="https://github.com/bloomberg/bucklescript">BuckleScript</a>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BuckleScript is mainly designed to solve the problems of large scale
JavaScript programming:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Lack of type-safety:</strong> [OCaml]((<a href="https://ocaml.org/" class="bare">https://ocaml.org/</a>) offers an
industrial-strength state-of-the-art type system and provides type
inference (i.e. No verbose type annotation required), which proves
<a href="http://programmers.stackexchange.com/questions/215482/what-are-the-safety-benefits-of-a-type-system">invaluable</a>
in managing large projects.</p>
</li>
<li>
<p><strong>Dead code:</strong> A large amount of web-development relies on inclusion
of code dependencies by copying or referencing CDNs (the very thing that
makes JavaScript highly accessible), but this also introduces a lot of
<a href="https://en.wikipedia.org/wiki/Dead_code">dead code</a>. This impacts
performance adversely when the JavaScript VM has to interpret code that
will never be invoked. BuckleScript provides powerful dead-code
elimination at all levels. Function and module level elimination is
facilitated by the sophistication of the type-system of OCaml, and at
the global level BuckleScript generates code ready for dead-code
elimination done by bundling tools such as the
<a href="https://developers.google.com/closure/compiler/">Google
closure-compiler</a>.</p>
</li>
<li>
<p><strong>Lack of offline optimizations:</strong> JavaScript is a dynamic language,
it takes a performance-hit for the VM to optimize code at runtime. While
some JS engines circumvent the problem to some extent by
<a href="http://v8project.blogspot.com/2015/07/code-caching.html">caching</a>, this
is not available to all environments, and lack of a strong type system
also limits the level of optimizations possible. Again, BuckleScript,
using features of the OCaml type-system and compiler implementation is
able to provide many optimizations during offline compilation, allowing
the runtime code to be extremely fast.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While a strong type-system helps in countering these problems, at the
same time we hope to avoid some of the problems faced in using other
offline
<a href="https://github.com/jashkenas/coffeescript/wiki/list-of-languages-that-compile-to-js">transpilation</a>
systems:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Slow compilation:</strong><br>
 OCaml bytecode compilation is known to be fast (one or two orders of
magnitude faster<br>
 than other similar langauges: <a href="http://www.scala-lang.org/">Scala</a><br>
 or <a href="https://www.haskell.org/">Haskell</a>), BuckleScript shares the same<br>
 property. See the speeds at work in the
<a href="http://bloomberg.github.io/bucklescript/js-demo/">playground</a>.</p>
</li>
<li>
<p><strong>Un-readable JS Code:</strong><br>
 In compiling to JavaScript, many systems generate code, that while
syntactically and semantically correct is<br>
 not human-readable and very difficult to debug. Our BuckleScript
implementation and the multi-pass compilation<br>
 strategy of OCaml, allows us to avoid
<a href="https://en.wikipedia.org/wiki/Name_mangling">name-mangling</a>, and produce
JavaScript code that is human-readable and easier to debug and maintain.</p>
</li>
<li>
<p><strong>Loss of code-structure:</strong><br>
 Many systems generate JavaScript code that is essentially a
<a href="https://en.wikipedia.org/wiki/Big_ball_of_mud">big ball of mud</a>. We try
to keep the original structure of the code by mapping one OCaml module
to one JS module.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resources-for-learning-ocaml">Resources for Learning OCaml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The offical <a href="https://ocaml.org/">ocaml</a> website has a comprehensive list
of tutorials about the OCaml language, targeted at both developers new
to functional programming and type-systems, and developers already
familiar with these concepts.
* Playground
There are two Playgrounds, one for<br>
<a href="https:////bloomberg.github.io/bucklescript/js-demo">vanilla OCaml</a>,<br>
the other for<br>
<a href="https:////bloomberg.github.io/bucklescript/reason-demo">Facebook Reason</a></p>
</div>
<div class="paragraph">
<p>Note that the playgrounds are only for demos and might not be the
latest.<br>
You should always use the command line as your production tool.
include::./Create-a-simple-example-with-NPM.adoc[Create a simple example
with NPM]
BuckleScript extends the OCaml compiler options with several flags to<br>
provide better experience for NPM users.</p>
</div>
<div class="sect2">
<h3 id="to-deploy-your-ocaml-library-as-a-npm-package">To deploy your OCaml library as a npm package</h3>
<div class="paragraph">
<p>In general, you are expected to deploy two kinds of artifacts, the<br>
generated JS files and meta data which your OCaml dependencies rely<br>
on.</p>
</div>
<div class="paragraph">
<p>Since CommonJS has no namespaces, to allow JS files live in different<br>
directories, we have a flag</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-name <span class="tok-nv">$npm_package_name</span> -bs-package-output path/to/your/js/dir -c a.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>By passing this flag, <code>bsc</code> will store your <code>package_name</code> and<br>
relative path to <code>package.json</code> in <code>.cmj</code> files. It will also generate<br>
JS files in the directory you specified. You can, and are encouraged<br>
to, store js files in a hierarchical directory.</p>
</div>
<div class="paragraph">
<p>For the binary artifacts, (Note that this is not necessary if you only<br>
want your libraries to be consumed by JS developers, and it has<br>
benefit since end users don&#8217;t need these binary data any more), the<br>
convention<br>
is to store all <code>*.cm</code> data in a <em>single</em> directory<br>
<code>package.json/lib/ocaml</code><br>
and js files in a <em>hierachical</em> directory<br>
<code>package.json/lib/js</code></p>
</div>
</div>
<div class="sect2">
<h3 id="to-use-ocaml-library-as-a-npm-package">To use OCaml library as a npm package</h3>
<div class="paragraph">
<p>If you follow the layout convention above, using an OCaml package is
pretty<br>
straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-include ocaml-library -c a.ml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conclusion">Conclusion</h3>
<div class="paragraph">
<p>Your command line would be like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-include ocaml-library1 -bs-npm-package-include
ocaml-library2 -bs-package-name <span class="tok-nv">$npm_package_name</span> -bs-package-output path/to/lib/js/ -c a.ml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bucklescript_basics_2">BuckleScript Basics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The compiler does not build</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In production mode, the compiler is a single file in
<code>jscomp/bin/compiler.ml</code>. If it is not compiling, make sure you have the
right OCaml compiler version. Currently the OCaml compiler is a
submodule of bucklescript. Make sure the exact commit hash matches (we
only update the compiler occasionally).</p>
</div>
<div class="paragraph">
<p>BuckleScript inherits the command line arguments of the
<a href="http://caml.inria.fr/pub/docs/manual-ocaml/comp.html">OCaml compiler</a>. It
also adds several flags:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-bs-main (single directory build)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-main main.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bsc</code> will build module <code>Main</code> and all its dependencies, when it<br>
finishes, it will run <code>node main.js</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -c -bs-main main.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same as above, but will not run <code>node</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-bs-files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So that you can do</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -c -bs-files *.ml *.mli</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will sort the order of input files before starting
compilation.</p>
</div>
<div class="paragraph">
<p>BuckleScript supports two compilation mode, script mode and package
mode, in package mode,<br>
you have to provide <code>package.json</code> on top and set the options
<code>-bs-package-name</code>, <code>-bs-package-output</code>.<br>
In script mode, such flags are not needed</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-bs-package-name<br>
The project name of your project, user is suggested to make it
consistent with the <code>name</code> field in <code>package.json</code></p>
</li>
<li>
<p>-bs-packge-output</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The format is <code>module_system:oupt/path/relative/to/package.json</code><br>
Currently supported module systesms are: <code>commonjs</code>, <code>amdjs</code> and
<code>goog:&lt;namespace&gt;</code></p>
</div>
<div class="paragraph">
<p>For example, when you want to use the <code>goog</code> module system, you can do
things like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">bsc -bs-package-name your_package -bs-package-output goog:lib/goog xx.ml</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that user can supply multiple <code>-bs-package-output</code> at the same time</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You would then need a bundler for the different module systems:
<code>webpack</code> supports <code>commonjs</code> and <code>amdjs</code> while
<code>google closure compiler</code> supports all.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-bs-gen-tds</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Trigger the generation of TypeScript <code>.d.ts</code> files.</p>
</div>
<div class="sect2">
<h3 id="hello-world">Hello world</h3>
<div class="paragraph">
<p>Currently, <code>BuckleScript</code> shares the same command line options as
<code>ocamlc</code><br>
bytecode compiler.</p>
</div>
<div class="paragraph">
<p>Create a file called <code>hello.ml</code> as below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nb">echo</span> <span class="tok-s1">&#39;print_endline &quot;hello world&quot;&#39;</span> &gt; hello.ml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -c hello.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything goes well, you should have <code>hello.js</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>console.log('hello world')</pre>
</div>
</div>
<div class="paragraph">
<p>include::./How-to-adapt-your-build-system.adoc[How to adapt your build
system]
include::./Semantic-differences-from-other-backends.adoc[Semantic
differences from other backends]
BuckleScript targets <strong>ES5</strong>.</p>
</div>
<div class="paragraph">
<p>Below is a list of polyfills from ES6 needed:</p>
</div>
<div class="paragraph">
<p><strong>Math.imul</strong></p>
</div>
<div class="paragraph">
<p>This polyfill is needed for <code>int32</code> multiplication. The polyfill is
actually implemented in the generated code.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>No action is required by the user.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>TypedArray</strong></p>
</div>
<div class="paragraph">
<p>The following functions require the TypedArray polyfill:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Int64.float_of_bits</p>
</li>
<li>
<p>Int64.bits_of_float</p>
</li>
<li>
<p>Int32.float_of_bits</p>
</li>
<li>
<p>Int32.bits_of_float</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The TypedArray polyfill is not provided by BuckleScript and it&#8217;s the
responsibility of the user to bundle the desired polyfill implementation
with the BuckleScript generated code.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>For the current BuckleScript version, if the user does not bundle the
TypedArray polyfill and the JavaScript engine does not support it, the
code will fail at runtime.</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>BuckleScript Overview
High Level compiler workflow
<sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub>~</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The high level architecture is illustrated below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Source Language
  |
  | (Reuse OCaml Parser)
  v
Surface Syntax Tree
  |
  | (built in Syntax tree transformation)
  v
Surface Syntax Tree
  |
  | (Reuse OCaml Type checker)
  v
Typedtree
  |
  | (Reuse OCaml pattern match compiler and erase types)
  v
Lambda IR (OCaml compiler libs) ---+
  |   ^                            |
  |   |                     Lambda Passes (lam_* files)
  |   |             Optimization/inlining/dead code elimination
  |   \                            |
  |    \ --------------------------+
  |
  |  Self tail call elimination
  |  Constant folding + propagation
  V
JS IR (J.ml)  ---------------------+
  |   ^                            |
  |   |                     JS Passes (js_* files)
  |   |            Optimization/inlining/dead code elimination
  |   \                            |
  |    \  -------------------------+
  |
  |  Smart printer includes scope analysis
  |
  V
Javascript Code</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="design-principles">Design Principles</h3>
<div class="paragraph">
<p>The current design of BuckleScript follows several high level
principles. While those principles might change in the future, there are
enforced today and can explain certain technical limitations
BuckleScript has.</p>
</div>
<div class="paragraph">
<p><strong>Lambda Representation</strong></p>
</div>
<div class="paragraph">
<p>As pictured in the diagram above, BuckleScript is primarily based on the
Lambda representation of the OCaml compiler. While this representation
is quite rich, some information is lost from the upstream
representation. The patch to the OCaml compiler tries to enrich this
representation in a non-intrusive way (see next section).</p>
</div>
<div class="paragraph">
<p><strong>Minimal Patch to the OCaml compiler</strong></p>
</div>
<div class="paragraph">
<p>BuckleScript requires patches to the OCaml compiler. One of the main
reasons is to enrich the Lambda representation so that the generated
code is as nice as possible. A design goal is to keep those patches
minimal and useful for the OCaml compiler in general so that they can
later be integrated.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A common question is to wonder why BuckleScript transpiles an OCaml
record value to a JavaScript array while a more intuitive representation
would be a JavaScript object. This technical decision is a direct
consequence of the above 2 design principles: the Lambda layer assumes
in a lot of places that a record value is an array and such modification
would be too large of a change to OCaml compiler.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Soundness</strong></p>
</div>
<div class="paragraph">
<p>BuckleScript preserves the soundness of the OCaml language. Assuming the
FFI is correctly implemented, the type safety is preserved.</p>
</div>
<div class="paragraph">
<p><strong>Minimal new symbol creation</strong></p>
</div>
<div class="paragraph">
<p>In order to make the JavaScript generated code as close as possible to
the original OCaml core we thrive to introduce as few new symbols as
possible.
* BuckleScript FFI</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="js-calling-ocaml">JS Calling OCaml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since BuckleScript guarantees that all OCaml functions are exported as
is, no extra work is required to expose OCaml function to JavaScript.</p>
</div>
<div class="paragraph">
<p>Some things need be taken care of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>external</code> exports are not exported as js functions, if you really<br>
want to export those external functions, please write <code>val</code> instead.</p>
</li>
<li>
<p><code>operators</code> are escaped, since Javascript does not support user<br>
 defined operators. For example instead of calling <code>Pervasives.(^)</code>,<br>
 you have to call <code>Pervasives.$caret</code> from your Javascript functions<br>
 (TODO: document the conversion rules).
To make OCaml work smoothly with Javascript, we introduced several<br>
extensions to the OCaml language. These BuckleScript extensions<br>
facilitate the integration of native JavaScript code and<br>
improve the generated code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Like TypeScript, when building typesafe bindings from JS to OCaml, the
user has to write type declarations.<br>
In OCaml, unlike TypeScript, user does not need to create a separate
<code>.d.ts</code> file,<br>
since the type declaration also written in OCaml.</p>
</div>
<div class="paragraph">
<p>The FFI is divided into several components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Binding to JS first-order functions</p>
</li>
<li>
<p>Binding to JS high-order functions</p>
</li>
<li>
<p>Binding to JS object literals</p>
</li>
<li>
<p>Binding to JS classes</p>
</li>
<li>
<p>Extensions to the language for debugger, regex and embedding raw JS
code</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="ffi-to-first-order-js-functions">FFI to first-order JS functions</h3>
<div class="paragraph">
<p>This part is similar to
<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.02/intfc.html">traditional
FFI</a>,<br>
with syntax as described below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>external value-name :  typexpr =  external-declaration  attributes
external-declaration :=  string-literal</pre>
</div>
</div>
<div class="paragraph">
<p>Users need to declare types for foreign functions (JS functions here)
and<br>
provide customized attributes.</p>
</div>
<div class="sect3">
<h4 id="attributes">Attributes</h4>
<div class="ulist">
<ul>
<li>
<p><code>bs.val</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">imul</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Math.imul&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that if you want to make a single FFI for both C functions and
JavaScript functions, you can<br>
 give the JavaScript foreign function a different name:</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">imul</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;c_imul&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span> <span class="tok-s2">&quot;Math.imul&quot;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.new</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This attribute is used to create a JavaScript object.<br>
 Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">create_date</span> <span class="tok-o">:</span> <span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Date&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">new</span><span class="tok-o">]</span>   <span class="tok-k">let</span> <span class="tok-n">date</span> <span class="tok-o">=</span> <span class="tok-n">create_date</span> <span class="tok-bp">()</span><span class="tok-o">`</span> <span class="tok-o">+</span>
 <span class="tok-n">will</span> <span class="tok-n">be</span> <span class="tok-n">compiled</span> <span class="tok-k">as</span><span class="tok-o">:</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">date</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.val</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This attribute is used to bind to a JavaScript value</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">dom</span>
<span class="tok-c">(* Abstract type for the DOM *)</span>

<span class="tok-k">external</span> <span class="tok-n">dom</span> <span class="tok-o">:</span> <span class="tok-n">dom</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;document&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span> <span class="tok-o">+</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.send</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This attribute helps the user send a message to a JS object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">id</span>      <span class="tok-c">(** Abstract type for id object *)</span>
<span class="tok-k">external</span> <span class="tok-n">get_by_id</span> <span class="tok-o">:</span> <span class="tok-n">dom</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;getElementById&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">send</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The object is always the first argument and actual arguments follow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">getElementById</span> <span class="tok-n">dom</span> <span class="tok-s2">&quot;xx&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"> <span class="tok-nx">dom</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;xx&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.get</code>, <code>bs.set</code><br>
This attribute helps get and set the property of a JavaScript object.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">textarea</span>
<span class="tok-k">external</span> <span class="tok-n">set_name</span> <span class="tok-o">:</span> <span class="tok-n">textarea</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span>
<span class="tok-k">external</span> <span class="tok-n">get_name</span> <span class="tok-o">:</span> <span class="tok-n">textarea</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.set_index</code> <code>bs.get_index</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This attribute allows dynamic access to a JavaScript property</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">module</span> <span class="tok-nc">Int32Array</span> <span class="tok-o">=</span> <span class="tok-k">struct</span>
   <span class="tok-k">type</span> <span class="tok-n">t</span>
   <span class="tok-k">external</span> <span class="tok-n">create</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Int32Array&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">new</span><span class="tok-o">]</span> <span class="tok-k">external</span> <span class="tok-n">get</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get_index</span><span class="tok-o">]</span><span class="tok-k">external</span> <span class="tok-n">set</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set_index</span><span class="tok-o">]</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bs.module</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Qualify the JavaScript value by a module name</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">add</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;add&quot;</span>
<span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">module</span> <span class="tok-s2">&quot;x&quot;</span><span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-n">add</span> <span class="tok-mi">3</span> <span class="tok-mi">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">X</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;x&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">f</span> <span class="tok-o">=</span> <span class="tok-nx">X</span><span class="tok-p">.</span><span class="tok-nx">add</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">,</span><span class="tok-mi">4</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">add</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;add&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">module</span> <span class="tok-s2">&quot;x&quot;</span> <span class="tok-s2">&quot;U&quot;</span><span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-n">add</span> <span class="tok-mi">3</span> <span class="tok-mi">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">U</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;x&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">f</span> <span class="tok-o">=</span> <span class="tok-nx">U</span><span class="tok-p">.</span><span class="tok-nx">add</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">,</span><span class="tok-mi">4</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ffi-to-high-order-js-functions">FFI to high-order JS functions</h3>
<div class="paragraph">
<p>High order functions are functions where the callback can be another
function. For example, suppose<br>
JS has a map function as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">map</span> <span class="tok-p">(</span><span class="tok-nx">a</span><span class="tok-p">,</span> <span class="tok-nx">b</span><span class="tok-p">,</span> <span class="tok-nx">f</span><span class="tok-p">){</span>
  <span class="tok-kd">var</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">min</span><span class="tok-p">(</span><span class="tok-nx">a</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">,</span> <span class="tok-nx">b</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">);</span>
  <span class="tok-kd">var</span> <span class="tok-nx">c</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Array</span><span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-p">);</span>
  <span class="tok-k">for</span><span class="tok-p">(</span><span class="tok-kd">var</span> <span class="tok-nx">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">j</span> <span class="tok-o">&lt;</span> <span class="tok-nx">i</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-nx">j</span><span class="tok-p">){</span>
    <span class="tok-nx">c</span><span class="tok-p">[</span><span class="tok-nx">j</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">a</span><span class="tok-p">[</span><span class="tok-nx">i</span><span class="tok-p">],</span><span class="tok-nx">b</span><span class="tok-p">[</span><span class="tok-nx">i</span><span class="tok-p">])</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-nx">c</span> <span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A naive external type declaration would be as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">map</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-kt">array</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-kt">array</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span> <span class="tok-kt">array</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;map&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, this is not completely correct. The issue is by<br>
reading the type <code>'a &#8594; 'b &#8594; 'c</code>, it can be in several cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">g</span> <span class="tok-n">x</span>  <span class="tok-o">=</span> <span class="tok-k">let</span> <span class="tok-n">z</span>  <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-mi">1</span> <span class="tok-k">in</span> <span class="tok-k">fun</span> <span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">z</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In OCaml, they all have the same type; however,<br>
<code>f</code> and <code>g</code> may be compiled into functions with<br>
different arities.</p>
</div>
<div class="paragraph">
<p>A naive compilation will compile <code>f</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-n">x</span> <span class="tok-o">-&gt;</span> <span class="tok-k">fun</span> <span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">y</span><span class="tok-p">){</span>
    <span class="tok-k">return</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">y</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span>
<span class="tok-kd">function</span> <span class="tok-nx">g</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">){</span>
  <span class="tok-kd">var</span> <span class="tok-nx">z</span> <span class="tok-o">=</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-mi">1</span> <span class="tok-p">;</span>
  <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">y</span><span class="tok-p">){</span>
    <span class="tok-k">return</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">z</span> <span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Its arity will be <em>consistent</em> but is <em>1</em> (returning another function);
however,<br>
we expect <em>its arity to be 2</em>.</p>
</div>
<div class="paragraph">
<p>Bucklescript uses a more complex compilation strategy, compiling <code>f</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">,</span><span class="tok-nx">y</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">y</span> <span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>No matter which strategy we use, existing typing rules cannot<br>
guarantee a function of type <code>'a &#8594; 'b &#8594; 'c</code> will have arity 2.</strong></p>
</div>
<div class="paragraph">
<p>To solve this problem introduced by OCaml&#8217;s curried calling convention,
we<br>
support a special attribute <code>[@bs]</code> at the type level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">map</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-kt">array</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-kt">array</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">])</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span> <span class="tok-kt">array</span>
<span class="tok-o">=</span> <span class="tok-s2">&quot;map&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>('a &#8594; 'b &#8594; 'c [@bs])</code> will <em>always be of arity 2</em>, in
general<br>
<code>'a0 &#8594; 'a1 &#8230;&#8203; 'aN &#8594; 'b0 [@bs]</code> is the same as
<code>'a0 &#8594; 'a1 &#8230;&#8203; 'aN &#8594; 'b0</code><br>
except the former&#8217;s arity is guaranteed to be <code>N</code> while the latter is
unknown.</p>
</div>
<div class="paragraph">
<p>To produce a function of type <code>'a0 &#8594; .. 'aN &#8594; 'b0 [@bs]</code>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a0</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a1</span> <span class="tok-o">-&gt;</span> <span class="tok-o">..</span> <span class="tok-k">&#39;</span><span class="tok-n">b0</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-n">a0</span> <span class="tok-n">a1</span> <span class="tok-o">..</span> <span class="tok-n">aN</span> <span class="tok-o">-&gt;</span> <span class="tok-n">b0</span>
<span class="tok-k">let</span> <span class="tok-n">b</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">b0</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-n">a0</span> <span class="tok-n">a1</span> <span class="tok-n">a2</span> <span class="tok-o">..</span> <span class="tok-n">aN</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A special case for arity of 0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">:</span> <span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b0</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-bp">()</span> <span class="tok-o">-&gt;</span> <span class="tok-n">b0</span>
<span class="tok-k">let</span> <span class="tok-n">b</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">b0</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-bp">()</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this extension to the OCaml language is <em>sound</em>. If you
add<br>
an attribute in one place but miss it in other place, the type checker<br>
will complain.</p>
</div>
<div class="paragraph">
<p>Another more complex example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">return</span> <span class="tok-o">=</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">u0</span> <span class="tok-o">=</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">return</span>  <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-c">(* [u0] has arity of 2, return a function</span>
<span class="tok-c">   with arity 1</span>
<span class="tok-c">*)</span>
<span class="tok-k">type</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">u1</span> <span class="tok-o">=</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-c">(* [u1] has arity of 3 *)</span>
<span class="tok-k">type</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">u2</span> <span class="tok-o">=</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">])</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-c">(* [u2] has arity of 2, reutrn a function</span>
<span class="tok-c">   with arity 1</span>
<span class="tok-c">*)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="uncurried-calling-convention-as-an-optimization">Uncurried calling convention as an optimization</h4>
<div class="sect4">
<h5 id="background">Background</h5>
<div class="paragraph">
<p>As we discussed before, we can compile any OCaml function as arity 1
to<br>
support OCaml&#8217;s curried calling convention.</p>
</div>
<div class="paragraph">
<p>This model is simple and easy to implement, but<br>
the native compilation is very slow and expensive for all functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-n">y</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span> <span class="tok-o">+</span> <span class="tok-n">z</span>
<span class="tok-k">let</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-mi">1</span> <span class="tok-mi">2</span> <span class="tok-mi">3</span>
<span class="tok-k">let</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-mi">1</span> <span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>can be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">y</span><span class="tok-p">){</span>
    <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">z</span><span class="tok-p">){</span>
      <span class="tok-k">return</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">y</span> <span class="tok-o">+</span> <span class="tok-nx">z</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span>
<span class="tok-kd">var</span> <span class="tok-nx">a</span> <span class="tok-o">=</span> <span class="tok-nx">f</span> <span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">b</span> <span class="tok-o">=</span> <span class="tok-nx">f</span> <span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But as you can see, this is <em>highly inefficient</em>, since the compiler
already <em>saw the source definition</em> of <code>f</code>,<br>
it can be optimized as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">,</span><span class="tok-nx">y</span><span class="tok-p">,</span><span class="tok-nx">z</span><span class="tok-p">)</span> <span class="tok-p">{</span><span class="tok-k">return</span> <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">y</span> <span class="tok-o">+</span> <span class="tok-nx">z</span><span class="tok-p">}</span>
<span class="tok-kd">var</span> <span class="tok-nx">a</span> <span class="tok-o">=</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">b</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">z</span><span class="tok-p">){</span><span class="tok-k">return</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-nx">z</span><span class="tok-p">)}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>BuckleScript does this optimization in the cross module level and tries
to infer the arity as much as it can.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="callback-optimization">Callback optimization</h4>
<div class="paragraph">
<p>However, such optimization will not work with <em>high-order</em> functions,<br>
i.e, callbacks.</p>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">app</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>f&#8217;s arity is unknown, the compiler can not do any optimization
(unless `app</code> gets inlined), so we<br>
have to generate code as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">app</span><span class="tok-p">(</span><span class="tok-nx">f</span><span class="tok-p">,</span><span class="tok-nx">x</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-nx">Curry</span><span class="tok-p">.</span><span class="tok-nx">_1</span><span class="tok-p">(</span><span class="tok-nx">f</span><span class="tok-p">,</span><span class="tok-nx">x</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Curry._1</code> is a function to dynamically support the curried calling
convention.</p>
</div>
<div class="paragraph">
<p>Since we support the uncurried calling convention, you can write <code>app</code><br>
as below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">app</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the type system will infer <code>app</code> as type<br>
<code>('a &#8594;'b [@bs]) &#8594; 'a</code> and compile <code>app</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">app</span><span class="tok-p">(</span><span class="tok-nx">f</span><span class="tok-p">,</span><span class="tok-nx">x</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that in OCaml the compiler internally uncurries every function
declared as <code>external</code><br>
and guarantees that it is always fully applied.<br>
Therfore, for <code>external</code> first-order FFI, its outermost function does
not need the <code>[@bs]</code><br>
annotation.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="bindings-to-callbacks-which-relies-on-this">Bindings to callbacks which relies on <code>this</code></h4>
<div class="paragraph">
<p>Many JS libraries have callbacks which rely on <code>this</code> (the source), for
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-nx">x</span><span class="tok-p">.</span><span class="tok-nx">onload</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">v</span><span class="tok-p">){</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">response</span> <span class="tok-o">+</span> <span class="tok-nx">v</span> <span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>this</code> would be the same as <code>x</code> (actually depends on how <code>onload</code>
is called). It is clear that<br>
it is not correct to declare <code>x.onload</code> of type <code>unit &#8594; unit [@bs]</code>.
Instead, we introduced a special attribute<br>
<code>bs.this</code> allowing us to type <code>x</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">x</span>
<span class="tok-k">external</span> <span class="tok-n">onload</span> <span class="tok-o">:</span> <span class="tok-n">x</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-n">x</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">])</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;onload&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span>
<span class="tok-k">external</span> <span class="tok-n">resp</span> <span class="tok-o">:</span> <span class="tok-n">x</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;response&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-o">]</span>
<span class="tok-n">onload</span> <span class="tok-n">x</span> <span class="tok-k">begin</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">]</span> <span class="tok-n">o</span> <span class="tok-n">v</span> <span class="tok-o">-&gt;</span>
  <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">log</span><span class="tok-o">(</span><span class="tok-n">resp</span> <span class="tok-n">o</span> <span class="tok-o">+</span> <span class="tok-n">v</span> <span class="tok-o">)</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated code would be as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-nx">x</span><span class="tok-p">.</span><span class="tok-nx">onload</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">v</span><span class="tok-p">){</span>
  <span class="tok-kd">var</span> <span class="tok-nx">o</span> <span class="tok-o">=</span> <span class="tok-k">this</span> <span class="tok-p">;</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">o</span><span class="tok-p">.</span><span class="tok-nx">response</span> <span class="tok-o">+</span> <span class="tok-nx">v</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bs.obj</code> is the same as <code>bs</code>: except that its first parameter is
reserved for <code>this</code> and for arity of 0, there<br>
is no need for a redundant <code>unit</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">obj</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">]</span> <span class="tok-n">obj</span> <span class="tok-o">-&gt;</span> <span class="tok-o">....</span>
<span class="tok-k">let</span> <span class="tok-n">f1</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">obj</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a0</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">this</span><span class="tok-o">]</span> <span class="tok-n">obj</span> <span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that there is no way to consume a function of type
<code>'obj &#8594; 'a0 .. &#8594; 'aN &#8594; 'b0 [@bs.this]</code> on the OCaml side and<br>
we don&#8217;t encourage people to write code in this style. This was
introduced mainly to be consumed by existing JS libraries.<br>
User can also type <code>x</code> as a JS class too (see later)</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ffi-to-js-plain-objects">FFI to JS plain objects</h3>
<div class="sect3">
<h4 id="js-object-convention">Js object convention</h4>
<div class="paragraph">
<p>All JS objects of type <code>'a</code> are lifted to type <code>'a Js.t</code> to avoid<br>
conflict with OCaml&#8217;s native object system (we support both OCaml&#8217;s
native object system and FFI to JS&#8217;s objects).</p>
</div>
<div class="paragraph">
<p><code><mark>#</code> is used in JS&#8217;s object method dispatch and field access,<br>
while <code></mark></code> is used in OCaml&#8217;s object method dispatch.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-simple-js-object-literal-and-its-typing">Create simple JS object literal and its typing</h4>
<div class="paragraph">
<p>BuckleScript introduces <code>bs.obj</code> extension, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">u</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-mi">3</span><span class="tok-o">}}}</span> <span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Would be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">u</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">y</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">z</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler would infer <code>u</code> as type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">u</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">x</span> <span class="tok-o">:</span>  <span class="tok-o">&lt;</span> <span class="tok-n">y</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">z</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">&gt;</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span> <span class="tok-o">&gt;</span>  <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span> <span class="tok-o">&gt;</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it more symmetric, we also apply the extension <code>bs.obj</code><br>
into the type level, so you can write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">u</span> <span class="tok-o">:</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span><span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">x</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">y</span> <span class="tok-o">&lt;</span> <span class="tok-n">z</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">&gt;</span> <span class="tok-o">&gt;</span> <span class="tok-o">&gt;</span> <span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Users can also write expressione and types together as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">u</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span> <span class="tok-o">(</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-o">}}}</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">x</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">y</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">z</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">&gt;</span> <span class="tok-o">&gt;</span> <span class="tok-o">&gt;</span> <span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Even better, users can also write Objects in a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">var</span> <span class="tok-n">xs</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span> <span class="tok-o">[|</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-o">}</span> <span class="tok-o">;</span> <span class="tok-o">{</span><span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-o">}</span> <span class="tok-o">|]</span> <span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">x</span> <span class="tok-o">:</span> <span class="tok-kt">int</span>  <span class="tok-o">&gt;</span> <span class="tok-kt">array</span>  <span class="tok-o">]</span>
<span class="tok-n">var</span> <span class="tok-n">ys</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span> <span class="tok-o">[|</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">3</span><span class="tok-o">}</span> <span class="tok-o">:</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">4</span> <span class="tok-o">}</span> <span class="tok-o">|]</span> <span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which will be compiled as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">xs</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-p">{</span> <span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span> <span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}]</span>
<span class="tok-kd">var</span> <span class="tok-nx">ys</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-p">{</span> <span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">},</span>  <span class="tok-p">{</span><span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-mi">4</span> <span class="tok-p">}</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bs.obj</code> can also be used as an attribute in external declarations, like
as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">make_config</span> <span class="tok-o">:</span> <span class="tok-n">hi</span><span class="tok-o">:</span><span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-n">lo</span><span class="tok-o">:</span><span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span><span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">make_config</span> <span class="tok-o">~</span><span class="tok-n">hi</span><span class="tok-o">:</span><span class="tok-mi">2</span> <span class="tok-o">~</span><span class="tok-n">lo</span><span class="tok-o">:</span><span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">  <span class="tok-kd">let</span> <span class="tok-nx">v</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-nx">hi</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-nx">lo</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use optional as well</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">make_config</span> <span class="tok-o">:</span> <span class="tok-n">hi</span><span class="tok-o">:</span><span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-o">?</span><span class="tok-n">lo</span><span class="tok-o">:</span><span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span><span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">u</span> <span class="tok-o">=</span> <span class="tok-n">make_config</span> <span class="tok-o">~</span><span class="tok-n">hi</span><span class="tok-o">:</span><span class="tok-mi">3</span> <span class="tok-bp">()</span>
<span class="tok-k">let</span> <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">make_config</span> <span class="tok-o">~</span><span class="tok-n">hi</span><span class="tok-o">:</span><span class="tok-mi">3</span> <span class="tok-o">~</span><span class="tok-n">lo</span><span class="tok-o">:</span><span class="tok-mi">2</span> <span class="tok-bp">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will generate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">let</span> <span class="tok-nx">u</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-nx">hi</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">}</span>
<span class="tok-kd">let</span> <span class="tok-nx">v</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-nx">hi</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">,</span> <span class="tok-nx">lo</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="field-access">Field access</h5>
<div class="paragraph">
<p>As we said <code>##</code> is used in both object method dispatch and field access.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">f</span><span class="tok-o">##</span><span class="tok-n">field</span> <span class="tok-c">(* field access should not come with any argument *)</span>
<span class="tok-n">f</span><span class="tok-o">##</span><span class="tok-k">method</span> <span class="tok-n">args0</span> <span class="tok-n">args1</span> <span class="tok-n">args2</span> <span class="tok-c">(* method with arities of 3 *)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JS&#8217;s <strong>method is not a function</strong> is a classic example shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">console</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-o">(</span><span class="tok-k">&#39;</span><span class="tok-n">fine&#39;</span><span class="tok-o">)</span>
<span class="tok-n">var</span> <span class="tok-n">log</span> <span class="tok-o">=</span> <span class="tok-n">console</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-o">;</span>
<span class="tok-n">log</span><span class="tok-o">(</span><span class="tok-k">&#39;</span><span class="tok-n">fine&#39;</span><span class="tok-o">)</span> <span class="tok-o">//</span> <span class="tok-nc">May</span> <span class="tok-n">cause</span> <span class="tok-k">exception</span><span class="tok-o">,</span> <span class="tok-n">implementation</span> <span class="tok-n">dependent</span><span class="tok-o">,</span> <span class="tok-o">`</span><span class="tok-n">console</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-o">`</span> <span class="tok-n">may</span> <span class="tok-n">depend</span> <span class="tok-n">on</span> <span class="tok-o">`</span><span class="tok-n">this</span><span class="tok-o">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So to make it clearly type safe, <code>field</code> accesses should not come with
any argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">fn</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">##</span><span class="tok-n">field</span> <span class="tok-k">in</span>
<span class="tok-k">let</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">fn</span> <span class="tok-n">a</span> <span class="tok-n">b</span>
<span class="tok-c">(* f##field a b would think `field` as a method *)</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that if a user were to make such a mistake, the type checker would
complain by saying it expected <code>Js.method</code> but saw a<br>
function instead, so it is still sound and type safe.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Currently <code>bs.obj</code> only supports plain JS object literals with no
support fpr JS methods, <code>class type</code> (discussed later) supports JS style
methods.</p>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">u</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span> <span class="tok-o">{</span><span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-o">}};</span> <span class="tok-n">fn</span> <span class="tok-o">=</span> <span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-n">u</span> <span class="tok-n">v</span> <span class="tok-o">-&gt;</span> <span class="tok-n">u</span> <span class="tok-o">+</span> <span class="tok-n">v</span> <span class="tok-o">}</span> <span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">x</span><span class="tok-o">##</span><span class="tok-n">y</span><span class="tok-o">##</span><span class="tok-n">z</span>
<span class="tok-k">let</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">h</span><span class="tok-o">##</span><span class="tok-n">fn</span>
<span class="tok-k">let</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">a</span> <span class="tok-mi">1</span> <span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will be compiled as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">u</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-nx">x</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">y</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">z</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">}},</span> <span class="tok-nx">fn</span> <span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">u</span><span class="tok-p">,</span><span class="tok-nx">v</span><span class="tok-p">)</span> <span class="tok-p">{</span><span class="tok-k">return</span> <span class="tok-nx">u</span> <span class="tok-o">+</span> <span class="tok-nx">v</span><span class="tok-p">}}</span>
<span class="tok-kd">var</span> <span class="tok-nx">h</span> <span class="tok-o">=</span> <span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">x</span><span class="tok-p">.</span><span class="tok-nx">y</span><span class="tok-p">.</span><span class="tok-nx">z</span>
<span class="tok-kd">var</span> <span class="tok-nx">a</span> <span class="tok-o">=</span> <span class="tok-nx">h</span><span class="tok-p">.</span><span class="tok-nx">fn</span>
<span class="tok-kd">var</span> <span class="tok-nx">b</span> <span class="tok-o">=</span> <span class="tok-nx">a</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the field is an uncurried function, there is a short-hand syntax as
below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">b</span> <span class="tok-n">x</span> <span class="tok-n">y</span> <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">h</span><span class="tok-o">#@</span><span class="tok-n">fn</span> <span class="tok-n">x</span> <span class="tok-n">y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">b</span> <span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">,</span><span class="tok-nx">y</span><span class="tok-p">,</span><span class="tok-nx">h</span><span class="tok-p">){</span>
  <span class="tok-k">return</span> <span class="tok-nx">h</span><span class="tok-p">.</span><span class="tok-nx">fn</span><span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">,</span><span class="tok-nx">y</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the compiler will infer the type of <code>b</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">b</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">obj</span><span class="tok-o">:</span> <span class="tok-o">&lt;</span> <span class="tok-n">fn</span> <span class="tok-o">:</span>  <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-o">]</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we said before, currently <code>[%bs.obj]</code> is only used for object
literals with no <code>this</code> semantics.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ffi-to-js-classes">FFI to JS classes</h3>
<div class="sect3">
<h4 id="class-type-declarations">Class type declarations</h4>
<div class="paragraph">
<p>Below is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">rect</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span>
  <span class="tok-k">method</span> <span class="tok-n">width</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span>
  <span class="tok-k">method</span> <span class="tok-n">draw</span> <span class="tok-o">:</span> <span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">rect</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">rect</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <code>class type</code> annotated with <code>[@bs]</code> is treated as a JS
class type.<br>
For JS classes, methods with arrow types are treated as real methods
while methods with non-arrow types<br>
are treated as properties. Since OCaml&#8217;s object system does not have
getters/setters, we introduced two<br>
attributes <code>bs.get</code> and <code>bs.set</code> to help inform BuckleScript to compile
them as property getters/setters.</p>
</div>
<div class="sect4">
<h5 id="annotation-to-js-properties">Annotation to JS properties</h5>
<div class="paragraph">
<p>There are various getter/setter decorations as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span> <span class="tok-o">{</span><span class="tok-n">no_get</span><span class="tok-o">}]</span>
  <span class="tok-c">(* [height] is setter only *)</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">y</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span>
<span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">y0</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span> <span class="tok-o">{</span><span class="tok-n">null</span><span class="tok-o">}]</span>
  <span class="tok-c">(* getter reutrn [int Js.null]*)</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">y0</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">y0</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span>
<span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">y1</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span> <span class="tok-o">{</span><span class="tok-n">undefined</span><span class="tok-o">}]</span>
  <span class="tok-c">(* getter return [int Js.undefined]*)</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">y1</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">y1</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span>
<span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">y2</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span> <span class="tok-o">{</span><span class="tok-n">undefined</span><span class="tok-o">;</span> <span class="tok-n">null</span><span class="tok-o">}]</span>
  <span class="tok-c">(* getter return [int Js.null_undefined] *)</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">y2</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">y2</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span>
<span class="tok-k">class</span> <span class="tok-k">type</span> <span class="tok-o">_</span><span class="tok-n">y3</span> <span class="tok-o">=</span> <span class="tok-k">object</span>
  <span class="tok-k">method</span> <span class="tok-n">height</span> <span class="tok-o">:</span> <span class="tok-kt">int</span>  <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">get</span> <span class="tok-o">{</span><span class="tok-n">undefined</span> <span class="tok-o">;</span> <span class="tok-n">null</span><span class="tok-o">}]</span>
  <span class="tok-c">(* getter only, return [int Js.null_undefined] *)</span>
<span class="tok-k">end</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span>
<span class="tok-k">type</span> <span class="tok-n">y3</span> <span class="tok-o">=</span> <span class="tok-o">_</span><span class="tok-n">y3</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">t</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="consume-js-class-api">Consume JS class API</h5>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-o">(</span><span class="tok-n">u</span> <span class="tok-o">:</span> <span class="tok-n">rect</span><span class="tok-o">)</span> <span class="tok-o">=</span>
  <span class="tok-c">(* the type annotation is un-necessary,</span>
<span class="tok-c">     but it gives better error message</span>
<span class="tok-c">  *)</span>
   <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">log</span> <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">height</span> <span class="tok-o">;</span>
   <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">log</span> <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">width</span> <span class="tok-o">;</span>
   <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">width</span> <span class="tok-o">#=</span> <span class="tok-mi">30</span><span class="tok-o">;</span>
   <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">height</span> <span class="tok-o">#=</span> <span class="tok-mi">30</span><span class="tok-o">;</span>
   <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">draw</span> <span class="tok-bp">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Would be compiled as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">function</span> <span class="tok-nx">f</span><span class="tok-p">(</span><span class="tok-nx">u</span><span class="tok-p">){</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">height</span><span class="tok-p">);</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">width</span><span class="tok-p">);</span>
  <span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">width</span> <span class="tok-o">=</span> <span class="tok-mi">30</span><span class="tok-p">;</span>
  <span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">height</span> <span class="tok-o">=</span> <span class="tok-mi">30</span><span class="tok-p">;</span>
  <span class="tok-k">return</span> <span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">draw</span><span class="tok-p">()</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the type system would guarantee that the user can not write such
code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">u</span><span class="tok-o">##</span><span class="tok-n">draw</span>
<span class="tok-c">(* use v later -- this is not allowed, type system will complain *)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is more type safe than JavaScript&#8217;s <strong>method is not function</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="method-chaining">Method chaining</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">f</span>
<span class="tok-o">##(</span><span class="tok-n">meth0</span> <span class="tok-bp">()</span><span class="tok-o">)</span>
<span class="tok-o">##(</span><span class="tok-n">meth1</span> <span class="tok-n">a</span><span class="tok-o">)</span>
<span class="tok-o">##(</span><span class="tok-n">meth2</span> <span class="tok-n">a</span> <span class="tok-n">b</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="embedding-raw-javascript-code">Embedding raw Javascript code</h3>
<div class="paragraph">
<p>Note that this is not encouraged. The user is should minimize and
localize use cases<br>
of embedding raw Javascript code; however, sometimes it&#8217;s necessary to
get the job done.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Embedding raw JS code as an expression</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">keys</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">string</span> <span class="tok-kt">array</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">raw</span> <span class="tok-s2">&quot;Object.keys&quot;</span> <span class="tok-o">]</span>
<span class="tok-k">let</span> <span class="tok-n">unsafe_lt</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">boolean</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">raw</span><span class="tok-o">{|</span><span class="tok-k">function</span><span class="tok-o">(</span><span class="tok-n">x</span><span class="tok-o">,</span><span class="tok-n">y</span><span class="tok-o">){</span><span class="tok-n">return</span> <span class="tok-n">x</span> <span class="tok-o">&lt;</span> <span class="tok-n">y</span><span class="tok-o">}|}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We recommend writing type annotations for such unsafe code. It is unsafe
to<br>
refer to external OCaml symbols in raw JS code.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Embedding raw JS code as statements</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-o">[%%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">raw</span><span class="tok-o">{|</span>
<span class="tok-n">console</span><span class="tok-o">.</span><span class="tok-n">log</span> <span class="tok-o">(</span><span class="tok-s2">&quot;hey&quot;</span><span class="tok-o">);</span>
<span class="tok-o">|}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Other examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">x</span>  <span class="tok-o">:</span> <span class="tok-kt">string</span> <span class="tok-o">=</span> <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">raw</span><span class="tok-o">{|</span><span class="tok-s2">&quot;</span><span class="tok-se">\x01\x02</span><span class="tok-s2">&quot;</span><span class="tok-o">|}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will be compiled into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-kd">var</span> <span class="tok-nx">x</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;\x01\x02&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Polyfill of <code>Math.imul</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">   <span class="tok-o">[%%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">raw</span><span class="tok-o">{|</span>
   <span class="tok-o">//</span> <span class="tok-nn">Math</span><span class="tok-p">.</span><span class="tok-n">imul</span> <span class="tok-n">polyfill</span>
   <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-nn">Math</span><span class="tok-p">.</span><span class="tok-n">imul</span><span class="tok-o">){</span>
       <span class="tok-nn">Math</span><span class="tok-p">.</span><span class="tok-n">imul</span> <span class="tok-o">=</span> <span class="tok-k">function</span> <span class="tok-o">(..)</span> <span class="tok-o">{..}</span>
    <span class="tok-o">}</span>
   <span class="tok-o">|}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>So far we don&#8217;t perform any sanity checks in the quoted text (syntax
checking is a long-term goal).</p>
</li>
<li>
<p>Users should not refer to symbols in OCaml code. It is not guaranteed
that the order is correct.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="debugger-support">Debugger support</h3>
<div class="paragraph">
<p>We introduced the extension <code>bs.debugger</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">  <span class="tok-k">let</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-n">y</span> <span class="tok-o">=</span>
    <span class="tok-o">[%</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">debugger</span><span class="tok-o">];</span>
    <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which will be compiled into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">  <span class="tok-kd">function</span> <span class="tok-nx">f</span> <span class="tok-p">(</span><span class="tok-nx">x</span><span class="tok-p">,</span><span class="tok-nx">y</span><span class="tok-p">)</span> <span class="tok-p">{</span>
     <span class="tok-kr">debugger</span><span class="tok-p">;</span> <span class="tok-c1">// JavaScript developer tools will set an breakpoint and stop here</span>
     <span class="tok-nx">x</span> <span class="tok-o">+</span> <span class="tok-nx">y</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="regex-support">Regex support</h3>
<div class="paragraph">
<p>We introduced <code>bs.re</code> for Javascript regex expresion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>let f  = [%bs.re "/b/g"]</pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will infer <code>f</code> has type <code>Js_re.t</code> and generate code as
below</p>
</div>
<div class="listingblock">
<div class="content">
<pre>var f = /b/g</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note that <code>Js_re.t</code> is an abstract type, we are working on providing
bindings for it</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="examples">Examples:</h3>
<div class="paragraph">
<p>Below is a simple example for <a href="https://mochajs.org/">mocha</a> library. For
more examples, please visit
<a href="https://github.com/bloomberg/bucklescript-addons" class="bare">https://github.com/bloomberg/bucklescript-addons</a></p>
</div>
<div class="sect3">
<h4 id="a-simple-example-binding-to-mocha-unit-test-library">A simple example: binding to mocha unit test library</h4>
<div class="paragraph">
<p>This is an example showing how too provide bindings to the
<a href="https://mochajs.org/">mochajs</a> unit test framework.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">describe</span> <span class="tok-o">:</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">])</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;describe&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span><span class="tok-o">]</span>
<span class="tok-k">external</span> <span class="tok-n">it</span> <span class="tok-o">:</span> <span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">unit</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">])</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;it&quot;</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span> <span class="tok-s2">&quot;it&quot;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since, <code>mochajs</code> is a test framework, we also need some assertion<br>
 tests. We can also describe the bindings to <code>assert.deepEqual</code> from<br>
 nodejs <code>assert</code> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">external</span> <span class="tok-n">eq</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;deepEqual&quot;</span>  <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">call</span><span class="tok-o">]</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-k">val</span> <span class="tok-s2">&quot;assert&quot;</span><span class="tok-o">]`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On top of this we can write normal OCaml functions, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">assert_equal</span> <span class="tok-o">=</span> <span class="tok-n">eq</span>
<span class="tok-k">let</span> <span class="tok-n">from_suites</span> <span class="tok-n">name</span> <span class="tok-n">suite</span>  <span class="tok-o">=</span>
    <span class="tok-n">describe</span> <span class="tok-n">name</span> <span class="tok-o">(</span><span class="tok-k">fun</span> <span class="tok-o">[@</span><span class="tok-n">bs</span><span class="tok-o">]</span> <span class="tok-bp">()</span> <span class="tok-o">-&gt;</span>           <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">iter</span> <span class="tok-o">(</span><span class="tok-k">fun</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">code</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">it</span> <span class="tok-n">name</span> <span class="tok-n">code</span><span class="tok-o">)</span> <span class="tok-n">suite</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler would generate code as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"> <span class="tok-kd">var</span> <span class="tok-nx">Assert</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;assert&quot;</span><span class="tok-p">);</span>
 <span class="tok-kd">var</span> <span class="tok-nx">List</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;bs-platform/lib/js/list&quot;</span><span class="tok-p">);</span>

<span class="tok-kd">function</span> <span class="tok-nx">assert_equal</span><span class="tok-p">(</span><span class="tok-nx">prim</span><span class="tok-p">,</span> <span class="tok-nx">prim$1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
 <span class="tok-k">return</span> <span class="tok-nx">Assert</span><span class="tok-p">.</span><span class="tok-nx">deepEqual</span><span class="tok-p">(</span><span class="tok-nx">prim</span><span class="tok-p">,</span> <span class="tok-nx">prim$1</span><span class="tok-p">);</span>
 <span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">from_suites</span><span class="tok-p">(</span><span class="tok-nx">name</span><span class="tok-p">,</span> <span class="tok-nx">suite</span><span class="tok-p">)</span> <span class="tok-p">{</span>
 <span class="tok-k">return</span> <span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-nx">name</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
 <span class="tok-k">return</span> <span class="tok-nx">List</span><span class="tok-p">.</span><span class="tok-nx">iter</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">param</span><span class="tok-p">)</span> <span class="tok-p">{</span>
 <span class="tok-k">return</span> <span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-nx">param</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-nx">param</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>
 <span class="tok-p">},</span> <span class="tok-nx">suite</span><span class="tok-p">);</span>
 <span class="tok-p">});</span>
 <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a description of how OCaml values are encoded in JavaScript,<br>
the <strong>internal</strong> description means <strong>users should not rely on its actual<br>
encoding (and it is subject to change)</strong>. We recommend that you write
setter/getter functions<br>
to manipulate safely OCaml values from JavaScript.</p>
</div>
<div class="paragraph">
<p>For example, users should not rely on how OCaml <code>list</code> is encoded in
JavaScript; instead,<br>
the OCaml stdlib provides three functions: <code>List.cons</code>, <code>List.hd</code> and
<code>List.tl</code>. JavaScript<br>
code should only rely on those three functions.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ocaml-type">OCaml type</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="int">int</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : number</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="nativeint">nativeint</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : number</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="int32">int32</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : number</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="int64">int64</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : an array of two numbers</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="float">float</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : number</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bool">bool</h3>
<div class="ulist">
<ul>
<li>
<p>true &#8594; 1</p>
</li>
<li>
<p>false &#8594; 0</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="char">char</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : number<br>
for example, <code>'a'</code> is encoded as its ascii code <code>97</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="string">string</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : string</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bytes">bytes</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : Number Array</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>TODO: investigate if we can encode it as buffer when in NodeJS.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="array">array</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type : Array.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="record-internal">record <em>internal</em></h3>
<div class="ulist">
<ul>
<li>
<p>javascript type: object<br>
For instance:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"> <span class="tok-k">type</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">x</span> <span class="tok-o">:</span> <span class="tok-kt">int</span><span class="tok-o">;</span> <span class="tok-n">y</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">}</span>
 <span class="tok-k">let</span> <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">;</span>  <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>v</code> is encoded as `[1,2]</p>
</div>
</div>
<div class="sect2">
<h3 id="tuple">tuple</h3>
<div class="ulist">
<ul>
<li>
<p>JavaScript type: Array<br>
for example, <code>(a,b)</code> is encoded as <code>[a,b]</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="a-option-internal"><code>'a option</code> <em>internal</em></h3>
<div class="ulist">
<ul>
<li>
<p><code>None</code> &#8594; <code>0</code></p>
</li>
<li>
<p><code>Some a</code> &#8594; <code>[a]</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="a-list-internal"><code>'a list</code> <em>internal</em></h3>
<div class="ulist">
<ul>
<li>
<p><code>[]</code> &#8594; <code>0</code></p>
</li>
<li>
<p><code>x::y</code> &#8594; <code>[x,y]</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="variant-internal">Variant <em>internal</em></h3>
<div class="ulist">
<ul>
<li>
<p>javascript type: object (for non nullary constructor)</p>
</li>
<li>
<p>javascript type: number (for nullary constructor)<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">t</span> <span class="tok-o">=</span>
  <span class="tok-o">|</span> <span class="tok-nc">A</span>
  <span class="tok-o">|</span> <span class="tok-nc">B</span> <span class="tok-k">of</span> <span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span>
  <span class="tok-o">|</span> <span class="tok-nc">C</span> <span class="tok-k">of</span> <span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span>
  <span class="tok-o">|</span> <span class="tok-nc">D</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>A</code> is encoded as <code>0</code>, <code>D</code> is encoded as <code>1</code>.<br>
 <code>B (1,2)</code> is encoded as <code>[1,2]</code> with property <code>tag</code> which is <code>0</code><br>
 you can imagine it is encoded as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-nb">Object</span><span class="tok-p">.</span><span class="tok-nx">defineProperty</span><span class="tok-p">([</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">],</span> <span class="tok-s1">&#39;tag&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-s1">&#39;value&#39;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>C (1,2)</code> is encoded as below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-nb">Object</span><span class="tok-p">.</span><span class="tok-nx">defineProperty</span><span class="tok-p">([</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">],</span> <span class="tok-s1">&#39;tag&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-s1">&#39;value&#39;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">})</span><span class="tok-err">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we clarified before, the internal representation should not be relied
upon, for example,<br>
 we might change the name of <code>tag</code> in the future.</p>
</div>
<div class="paragraph">
<p>We are working to provide a ppx extension as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">t</span> <span class="tok-o">=</span>
  <span class="tok-o">|</span> <span class="tok-nc">A</span>
  <span class="tok-o">|</span> <span class="tok-nc">B</span> <span class="tok-k">of</span> <span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span>
  <span class="tok-o">|</span> <span class="tok-nc">C</span> <span class="tok-k">of</span> <span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span>
  <span class="tok-o">|</span> <span class="tok-nc">D</span> <span class="tok-o">[@@</span><span class="tok-n">bs</span><span class="tok-o">.</span><span class="tok-n">export</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So that it will a automatically provide <code>constructing</code> and
<code>destructing</code> function</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">a</span> <span class="tok-o">:</span> <span class="tok-n">t</span>
<span class="tok-k">val</span> <span class="tok-n">b</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span>
<span class="tok-k">val</span> <span class="tok-n">c</span> <span class="tok-o">:</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">int</span> <span class="tok-o">-&gt;</span> <span class="tok-n">t</span>
<span class="tok-k">val</span> <span class="tok-n">d</span> <span class="tok-o">:</span> <span class="tok-kt">int</span>

<span class="tok-k">val</span> <span class="tok-n">a_of_t</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">bool</span>
<span class="tok-k">val</span> <span class="tok-n">d_of_t</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">bool</span>
<span class="tok-k">val</span> <span class="tok-n">b_of_t</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span> <span class="tok-o">)</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">opt</span>
<span class="tok-k">val</span> <span class="tok-n">c_of_t</span> <span class="tok-o">:</span> <span class="tok-n">t</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span> <span class="tok-o">)</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">opt</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="polymorphic-variant-internal">Polymorphic variant <em>internal</em></h3>
<div class="ulist">
<ul>
<li>
<p>javascript type: number (nullary constructor)</p>
</li>
<li>
<p>javascript type: object (non-nullary constructor)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">type</span> <span class="tok-n">t</span> <span class="tok-o">=</span>
    <span class="tok-o">|</span> <span class="tok-o">`</span><span class="tok-nc">A</span>
    <span class="tok-o">|</span> <span class="tok-o">`</span><span class="tok-nc">B</span> <span class="tok-k">of</span> <span class="tok-kt">int</span> <span class="tok-o">*</span> <span class="tok-kt">int</span>
    <span class="tok-o">|</span> <span class="tok-o">`</span><span class="tok-nc">C</span> <span class="tok-k">of</span> <span class="tok-kt">int</span>
    <span class="tok-o">|</span> <span class="tok-o">`</span><span class="tok-nc">D</span> <span class="tok-o">[@@</span><span class="tok-n">bb</span><span class="tok-o">.</span><span class="tok-n">export</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For nullary constructor, <strong>`A</strong>, it is encoded as a hash function,
<strong>users should not rely  on how the hash function works</strong>.
 For documentation purpose, <strong>\`A</strong> is encoded as number `65`</p>
</div>
<div class="paragraph">
<p><strong>`B(1,2)</strong> is encoded as `[66, [1,2] ]`</p>
</div>
<div class="paragraph">
<p><strong>`C 3</strong> is encoded as `[67, 3]`</p>
</div>
</div>
<div class="sect2">
<h3 id="exception-internal">exception <em>internal</em></h3>

</div>
<div class="sect2">
<h3 id="extension-internal">extension <em>internal</em></h3>

</div>
<div class="sect2">
<h3 id="object-internal">object <em>internal</em></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="javascript-type-exposed-to-ocaml">JavaScript type exposed to OCaml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BuckleScript exposes type safe interfaces to JavaScript native types.
Those can be found in the <code>Js</code> module.</p>
</div>
<div class="sect2">
<h3 id="js.boolean"><code>Js.boolean</code></h3>
<div class="ulist">
<ul>
<li>
<p>javascript type: boolean<br></p>
</li>
<li>
<p>Js.true_ &#8594; true</p>
</li>
<li>
<p>Js.false_ &#8594; false<br>
 We also provide a function <code>Js.to_bool</code> to convert <code>Js.boolean</code> to
OCaml <code>bool</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">to_bool</span> <span class="tok-o">:</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">boolean</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">bool</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="a-js.opt"><code>'a Js.opt</code></h3>
<div class="ulist">
<ul>
<li>
<p>either <code>'a</code> or <code>null</code><br>
 We provide several functions in <code>Js</code> module for constructing and
destructing:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">from_opt</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">opt</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">option</span>
<span class="tok-k">val</span> <span class="tok-n">to_opt</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">opt</span>
<span class="tok-k">val</span> <span class="tok-n">is_nil</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">opt</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">bool</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s more efficient than <code>'a option</code> since it is unboxed. When the user wants to get the value, he can write code as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"> <span class="tok-k">match</span> <span class="tok-nn">Js</span><span class="tok-p">.</span><span class="tok-n">from_opt</span> <span class="tok-n">x</span> <span class="tok-k">with</span>
 <span class="tok-o">|</span> <span class="tok-nc">Some</span> <span class="tok-n">x</span> <span class="tok-o">-&gt;</span>        <span class="tok-c">(* non null branch *)</span>
   <span class="tok-k">begin</span>       <span class="tok-c">(* ... *)</span>        <span class="tok-k">end</span>
 <span class="tok-o">|</span> <span class="tok-nc">None</span> <span class="tok-o">-&gt;</span>       <span class="tok-c">(* null *)</span>
   <span class="tok-k">begin</span>       <span class="tok-c">(* ... *)</span>        <span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>Js.from_opt</code> is in generally optimized, so that it will not be boxed when converted to <code>'a option</code> and destructured
immediately.</p>
</div>
</div>
<div class="sect2">
<h3 id="a-js.def"><code>'a Js.def</code></h3>
<div class="ulist">
<ul>
<li>
<p>either <code>'a'</code> or <code>undefined</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We provide several functions in <code>Js</code> module for constructing and
destructing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">val</span> <span class="tok-n">from_def</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">def</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">option</span>
<span class="tok-k">val</span> <span class="tok-n">to_def</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">opt</span>
<span class="tok-k">val</span> <span class="tok-n">is_undef</span> <span class="tok-o">:</span> <span class="tok-k">&#39;</span><span class="tok-n">a</span> <span class="tok-n">def</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">bool</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note in the future, we will have a <em>debug</em> mode, in which the<br>
corresponding js encoding will be instrumented with more information
using <code>Object.defineProperty</code></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>include::./Experimental-support-of-typescript.adoc[Experimental support of
typescript]
Because of the JavaScript environment limitation, <code>Pervasives.stdin</code> is
not supported but both <code>Pervasives.stdout</code> and <code>Pervasives.stderr</code> are.
* Contributions</p>
</div>
<div class="sect3">
<h4 id="build-the-compiler">Build the compiler</h4>
<div class="paragraph">
<p>The development of BuckleScript compiler relies on 2 tools which are
readily available in <code>opam</code> and work with our patched OCaml compiler:</p>
</div>
<div class="paragraph">
<p>*
<a href="http://caml.inria.fr/pub/docs/manual-ocaml-400/manual032.html">ocamlbuild</a>:
Default build tool for OCaml project
* <a href="https://github.com/ocaml/camlp4">camlp4</a>: Tool used to generate OCaml
code for processing large AST. (j.ml file).</p>
</div>
<div class="paragraph">
<p>After having installed the above dependencies from opam you can run the
following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nb">cd </span>jscomp/
./build.sh</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="build-the-runtime">Build the runtime</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nb">cd</span> ./runtime<span class="tok-p">;</span> make all</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="build-the-stdlib">Build the stdlib</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nb">cd</span> ./stdlib<span class="tok-p">;</span> make all</code></pre>
</div>
</div>
<div class="paragraph">
<p>include::./Help-move-runtime-functions-from-OCaml-to-Javascript.adoc[Help
move runtime functions from OCaml to Javascript]
* Roadmap
Alpha release</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; Support format module and all currying</p>
</li>
<li>
<p>&#10003; Int32</p>
</li>
<li>
<p>&#10003; Int64 support</p>
</li>
<li>
<p>&#10003; Documentation about the Run-time encoding</p>
</li>
<li>
<p>&#10003; Stabilize non-object part of FFI</p>
</li>
<li>
<p>&#10003; Document non-object part of FFI</p>
</li>
<li>
<p>&#10003; All files in run-time are ml files</p>
</li>
<li>
<p>&#10003; Recursive module</p>
</li>
<li>
<p>&#10003; Lazy values</p>
</li>
<li>
<p>&#10003; Create a package for opam for the patched compiler, so user can
use bucklescript with other ocaml tool chains like<br>
merlin</p>
</li>
<li>
<p>&#10003; Document difference from ocaml native backend</p>
</li>
<li>
<p>&#10003; Document difference from Js_of_ocaml</p>
</li>
<li>
<p>&#10003; Support goog.module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Beta release:</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; Object part of FFI (we have a working solution; the name mangling
is not ideal)</p>
</li>
<li>
<p>&#10063; Compile local module as dictionary</p>
</li>
<li>
<p>&#10063; Custom formatter in debug mode</p>
</li>
<li>
<p>&#10063; Improving Runtime library (no unsafe code)</p>
</li>
<li>
<p>&#10063; Support es6 module (rollup format) (we current support commonjs
and amdjs)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Release:</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; Bindings to Dom and React</p>
</li>
<li>
<p>&#10063; Bigarray/Bignum support</p>
</li>
<li>
<p>&#10063; Native JS regex suport</p>
</li>
<li>
<p>&#10063; Improve curry performance</p>
</li>
<li>
<p>&#10063; Google closure compiler advanced mode</p>
</li>
<li>
<p>&#10063; Source map support</p>
</li>
<li>
<p>&#10063; Catch up with the new release of ocaml compiler</p>
</li>
<li>
<p>Comparisons
<a href="https://github.com/ocsigen/js_of_ocaml">js_of_ocaml</a> is a popular
compiler which compiles OCaml&#8217;s bytecode into JavaScript. It is the
inspiration for this project, and has already been under development for
several years and is ready for production. In comparison, BuckleScript,
while moving fast, is still a very young project. BuckleScript&#8217;s
motivation, like <code>js_of_ocaml</code>, is to unify the ubiquity of the
JavaScript platform and the truly sophisticated type system of OCaml,
however, there are some areas where we view things differently from
<code>js_of_ocaml</code>. We describe below, some of these differences, and also
refer readers to some of the original informal
<a href="https://github.com/ocsigen/js_of_ocaml/issues/338">discussions</a>.</p>
</li>
<li>
<p>Js_of_ocaml takes lowlevel bytecode from OCaml compiler, BuckleScript
takes the highlevel rawlambda representation from OCaml compiler</p>
</li>
<li>
<p>Js_of_ocaml focuses more on existing OCaml eco-system(opam) while
BuckleScript&#8217;s major goal is to target npm</p>
</li>
<li>
<p>Js_of_ocaml and BuckleScript have slightly different runtime encoding
in several places, for example, BuckleScript encodes OCaml Array as JS
Array while js_of_ocaml requires its index 0 to be of value 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both projects are improving quickly, so this can change in the future!</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-08-21 10:40:01 EDT
</div>
</div>
</body>
</html>